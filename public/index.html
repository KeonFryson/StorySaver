<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>StorySaver</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		.line-clamp-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.line-clamp-3 {
			display: -webkit-box;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		#add-story-modal-backdrop {
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.3);
			z-index: 40;
			display: none;
		}

		#add-story-modal {
			z-index: 50;
		}
	</style>
</head>
<body class="min-h-screen bg-white text-gray-900 transition-colors duration-300" id="body-root">
	<div id="app">
		<!-- Auth Page (hidden by default) -->
		<div id="auth-page" class="min-h-screen bg-gray-50 text-gray-900 flex items-center justify-center p-4 hidden">
			<div class="w-full max-w-md bg-white rounded-lg shadow-lg p-6 border border-gray-200">
				<div class="text-center mb-6">
					<h1 class="text-3xl font-bold text-blue-600 mb-2">StorySaver</h1>
					<p class="text-gray-600">Archive your favorite stories like AO3</p>
				</div>
				<form id="auth-form" class="space-y-4">
					<div>
						<label for="email" class="block text-sm font-medium text-gray-900 mb-2">
							Email
						</label>
						<input id="email"
							   type="email"
							   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
							   placeholder="your@email.com"
							   required />
					</div>
					<div>
						<label for="password" class="block text-sm font-medium text-gray-900 mb-2">
							Password
						</label>
						<input id="password"
							   type="password"
							   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
							   placeholder="••••••••"
							   required />
					</div>
					<button type="submit"
							class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
						Sign In
					</button>
				</form>
				<div class="mt-4 text-center">
					<button type="button"
							id="toggle-signup"
							class="text-blue-600 hover:text-blue-700 text-sm">
						Need an account? Sign up
					</button>
				</div>
				<div class="mt-6 p-4 bg-gray-100 rounded-lg">
					<h3 class="font-semibold text-gray-900 mb-2">Why StorySaver?</h3>
					<ul class="text-sm text-gray-600 space-y-1">
						<li>• Save stories from AO3, SpaceBattles, and more</li>
						<li>• Organize with tags and categories</li>
						<li>• Access your library anywhere</li>
						<li>• Never lose your favorite reads</li>
					</ul>
				</div>
			</div>
		</div>

		<!-- Dashboard Page (visible by default) -->
		<div id="dashboard-page" class="min-h-screen bg-gray-50 text-gray-900 transition-colors duration-300">
			<!-- Header -->
			<header class="bg-white border-b border-gray-200 shadow-sm transition-colors duration-300">
				<div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
					<div>
						<h1 class="text-2xl font-bold text-blue-600">StorySaver</h1>
						<p class="text-sm text-gray-600">Your personal story archive</p>
					</div>
					<div class="flex items-center gap-4">
						<span class="text-gray-900" id="welcome-user">Welcome, Guest</span>
						<button id="darkmode-btn"
								class="bg-gray-200 text-gray-800 px-3 py-2 rounded-md hover:bg-gray-300 transition-colors text-sm"
								title="Toggle dark mode">
							Dark Mode
						</button>
						<button id="signin-btn"
								class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
							Sign In
						</button>
						<button id="logout-btn"
								class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors text-sm hidden">
							Logout
						</button>
					</div>
				</div>
			</header>
			<div class="max-w-6xl mx-auto px-4 py-8 relative">
				<!-- Floating + Button -->
				<button id="show-add-story-btn"
						class="fixed bottom-8 right-8 bg-blue-600 text-white rounded-full w-16 h-16 flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 transition-colors z-50"
						title="Add New Story"
						style="box-shadow: 0 4px 24px rgba(0,0,0,0.15);">
					+
				</button>

				<!-- Add Story Modal (hidden by default) -->
				<div id="add-story-modal-backdrop"></div>
				<div id="add-story-modal" class="fixed inset-0 flex items-center justify-center hidden">
					<div class="bg-white rounded-lg border border-gray-200 p-6 shadow-lg w-full max-w-lg relative add-story-box">
						<button id="close-add-story-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl font-bold" title="Close">&times;</button>
						<h2 class="text-xl font-semibold text-gray-900 mb-4">Add New Story</h2>
						<form id="story-form" class="space-y-4">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-900 mb-2">
										Title *
									</label>
									<input id="story-title"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="Story title"
										   required />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 mb-2">
										Author
									</label>
									<input id="story-author"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="Author name" />
								</div>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-900 mb-2">
										Chapter
									</label>
									<input id="story-chapter"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="e.g. 1, 2, Prologue, etc." />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 mb-2">
										URL
									</label>
									<input id="story-url"
										   type="url"
										   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="https://archiveofourown.org/works/..." />
								</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-900 mb-2">
									Content or Summary
								</label>
								<textarea id="story-content"
										  rows="3"
										  class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
										  placeholder="Paste content or write a summary..."></textarea>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-900 mb-2">
									Tags (comma-separated)
								</label>
								<input id="story-tags"
									   type="text"
									   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
									   placeholder="fanfiction, sci-fi, romance" />
							</div>
							<button type="submit"
									class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors font-medium">
								Save Story
							</button>
						</form>
					</div>
				</div>
				<!-- Stories Grid -->
				<div>
					<h2 class="text-2xl font-semibold text-gray-900 mb-6">Your Saved Stories (<span id="stories-count">0</span>)</h2>
					<div id="empty-state" class="text-center py-12 bg-gray-100 rounded-lg border border-gray-200">
						<p class="text-gray-600">No stories saved yet. Add your first story above!</p>
					</div>
					<div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
						<!-- Stories will be dynamically added here -->
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		function setDarkMode(enabled) {
			const body = document.getElementById('body-root');
			const dashboard = document.getElementById('dashboard-page');
			const auth = document.getElementById('auth-page');
			const headers = document.querySelectorAll('header, .bg-white, .bg-gray-50');
			const storyBoxes = document.querySelectorAll('.story-card, .add-story-box, #empty-state');

			const removeClasses = [
				'bg-gray-900', 'bg-gray-800', 'bg-gray-700', 'bg-gray-50', 'bg-white',
				'text-white', 'text-gray-900', 'border-gray-600', 'border-gray-200',
				'bg-gray-100', 'text-gray-600', 'placeholder-gray-500'
			];

			const inputs = document.querySelectorAll(
				'.add-story-box input, .add-story-box textarea, .add-story-box select, ' +
				'.story-card input, .story-card textarea, .story-card select, ' +
				'#auth-form input, #auth-form textarea, #auth-form select'
			);

			const whyBox = document.querySelector('#auth-page .bg-gray-100.rounded-lg, #auth-page .bg-gray-700.rounded-lg');
			const whyBoxTexts = whyBox ? whyBox.querySelectorAll('.text-gray-900, .text-gray-600, .text-white') : [];
			const authCard = document.querySelector('#auth-page > .bg-white, #auth-page > .bg-gray-900, #auth-page > .bg-gray-800, #auth-page > .bg-gray-700');

			if (enabled) {
				body.classList.remove(...removeClasses);
				body.classList.add('bg-gray-900', 'text-white');
				if (dashboard) {
					dashboard.classList.remove(...removeClasses);
					dashboard.classList.add('bg-gray-800', 'text-white');
				}
				if (auth) {
					auth.classList.remove(...removeClasses);
					auth.classList.add('bg-gray-800', 'text-white');
				}
				headers.forEach(el => {
					el.classList.remove(...removeClasses);
					el.classList.add('bg-gray-900', 'text-white');
				});
				storyBoxes.forEach(el => {
					el.classList.remove(...removeClasses);
					el.classList.add('bg-gray-700', 'text-white', 'border-gray-600');
				});
				inputs.forEach(input => {
					input.classList.remove(...removeClasses);
					input.classList.add('bg-gray-900', 'text-white', 'placeholder-gray-400', 'border-gray-600');
				});
				const authTexts = document.querySelectorAll(
					'#auth-page .text-gray-900, #auth-page .text-gray-600, #auth-page .text-blue-600, #auth-page .font-semibold'
				);
				authTexts.forEach(el => {
					el.classList.remove('text-gray-900', 'text-gray-600', 'text-blue-600');
					el.classList.add('text-white');
				});
				const dashboardTexts = document.querySelectorAll(
					'#dashboard-page .text-gray-900, #dashboard-page .text-gray-600'
				);
				dashboardTexts.forEach(el => {
					el.classList.remove('text-gray-900', 'text-gray-600');
					el.classList.add('text-white');
				});
				if (whyBox) {
					whyBox.classList.remove('bg-gray-100', 'border-gray-200');
					whyBox.classList.add('bg-gray-700', 'border-gray-600');
				}
				whyBoxTexts.forEach(el => {
					el.classList.remove('text-gray-900', 'text-gray-600');
					el.classList.add('text-white');
				});
				if (authCard) {
					authCard.classList.remove('bg-white', 'text-gray-900', 'border-gray-200');
					authCard.classList.add('bg-gray-900', 'text-white', 'border-gray-600');
				}
			} else {
				body.classList.remove(...removeClasses);
				body.classList.add('bg-white', 'text-gray-900');
				if (dashboard) {
					dashboard.classList.remove(...removeClasses);
					dashboard.classList.add('bg-gray-50', 'text-gray-900');
				}
				if (auth) {
					auth.classList.remove(...removeClasses);
					auth.classList.add('bg-gray-50', 'text-gray-900');
				}
				headers.forEach(el => {
					el.classList.remove(...removeClasses);
					el.classList.add('bg-white', 'text-gray-900');
				});
				storyBoxes.forEach(el => {
					el.classList.remove(...removeClasses);
					el.classList.add('bg-white', 'text-gray-900', 'border-gray-200');
				});
				inputs.forEach(input => {
					input.classList.remove(...removeClasses);
					input.classList.add('bg-white', 'text-gray-900', 'placeholder-gray-500', 'border-gray-300');
				});
				const authTexts = document.querySelectorAll(
					'#auth-page .text-white'
				);
				authTexts.forEach(el => {
					el.classList.remove('text-white');
					el.classList.add('text-gray-900');
				});
				const dashboardTexts = document.querySelectorAll(
					'#dashboard-page .text-white'
				);
				dashboardTexts.forEach(el => {
					el.classList.remove('text-white');
					if (el.tagName === 'H2' || el.id === 'welcome-user') {
						el.classList.add('text-gray-900');
					} else {
						el.classList.add('text-gray-600');
					}
				});
				document.querySelectorAll(
					'#story-form button[type="submit"], #signin-btn'
				).forEach(btn => {
					btn.classList.add('text-white');
				});
				if (whyBox) {
					whyBox.classList.remove('bg-gray-700', 'border-gray-600');
					whyBox.classList.add('bg-gray-100', 'border-gray-200');
				}
				whyBoxTexts.forEach(el => {
					el.classList.remove('text-white');
					if (el.tagName === 'H3') {
						el.classList.add('text-gray-900');
					} else {
						el.classList.add('text-gray-600');
					}
				});
				if (authCard) {
					authCard.classList.remove('bg-gray-900', 'bg-gray-800', 'bg-gray-700', 'text-white', 'border-gray-600');
					authCard.classList.add('bg-white', 'text-gray-900', 'border-gray-200');
				}
			}
			localStorage.setItem('storySaverDarkMode', enabled ? '1' : '0');
		}
		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('welcome-user').textContent = 'Welcome, Guest';
			document.getElementById('logout-btn').classList.add('hidden');
			document.getElementById('signin-btn').classList.remove('hidden');

			document.getElementById('signin-btn').addEventListener('click', function () {
				document.getElementById('dashboard-page').classList.add('hidden');
				document.getElementById('auth-page').classList.remove('hidden');
				const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
				setDarkMode(darkMode);
			});

			const darkBtn = document.getElementById('darkmode-btn');
			let darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);
			darkBtn.textContent = darkMode ? 'Light Mode' : 'Dark Mode';
			darkBtn.addEventListener('click', function () {
				darkMode = !darkMode;
				setDarkMode(darkMode);
				darkBtn.textContent = darkMode ? 'Light Mode' : 'Dark Mode';
			});

			document.getElementById('auth-form').addEventListener('submit', handleAuth);
			document.getElementById('toggle-signup').addEventListener('click', toggleSignUp);
			document.getElementById('story-form').addEventListener('submit', handleSaveStory);
			document.getElementById('logout-btn').addEventListener('click', handleLogout);

			// Modal logic
			document.getElementById('add-story-modal').classList.add('hidden');
			document.getElementById('add-story-modal-backdrop').style.display = 'none';
			document.getElementById('show-add-story-btn').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.remove('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'block';
			});
			document.getElementById('close-add-story-btn').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
			});
			document.getElementById('add-story-modal-backdrop').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
			});

			const savedUser = localStorage.getItem('storySaverUser');
			if (savedUser) {
				const user = JSON.parse(savedUser);
				showDashboard(user.email);
				loadStories(user.id);
			} else {
				renderStories([]);
			}
		});

		async function handleAuth(e) {
			e.preventDefault();
			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;
			const isSignUp = document.getElementById('toggle-signup').textContent.trim() === 'Already have an account? Sign in';

			if (isSignUp) {
				const res = await fetch('/api/users', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, username: email, password })
				});
				const data = await res.json();
				if (res.ok) {
					alert('Account created successfully!');
					toggleSignUp();
				} else {
					alert(data.error || 'Sign up failed');
				}
			} else {
				const res = await fetch('/api/auth', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, password })
				});
				const data = await res.json();
				if (res.ok && data.user) {
					localStorage.setItem('storySaverUser', JSON.stringify(data.user));
					showDashboard(data.user.email);
					loadStories(data.user.id);
				} else {
					alert(data.error || 'Invalid credentials!');
				}
			}
		}

		function toggleSignUp() {
			const button = document.getElementById('toggle-signup');
			const submitBtn = document.getElementById('auth-form').querySelector('button[type="submit"]');
			if (button.textContent.trim() === 'Need an account? Sign up') {
				button.textContent = 'Already have an account? Sign in';
				submitBtn.textContent = 'Create Account';
			} else {
				button.textContent = 'Need an account? Sign up';
				submitBtn.textContent = 'Sign In';
			}
		}

		function showDashboard(userEmail) {
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('welcome-user').textContent = 'Welcome, ' + userEmail;
			document.getElementById('logout-btn').classList.remove('hidden');
			document.getElementById('signin-btn').classList.add('hidden');
			const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);
		}

		async function loadStories(userId) {
			if (!userId) {
				renderStories([]);
				return;
			}
			const res = await fetch(`/api/stories?user_id=${encodeURIComponent(userId)}`);
			const stories = res.ok ? await res.json() : [];
			renderStories(stories);
		}

		async function handleSaveStory(e) {
			e.preventDefault();
			const user = JSON.parse(localStorage.getItem('storySaverUser') || 'null');
			if (!user) {
				alert('Please sign in to save stories.');
				return;
			}
			const newStory = {
				user_id: user.id,
				title: document.getElementById('story-title').value,
				description: document.getElementById('story-content').value,
				chapter: document.getElementById('story-chapter').value,
				author: document.getElementById('story-author').value,
				url: document.getElementById('story-url').value,
				tags: document.getElementById('story-tags').value
			};
			const res = await fetch('/api/stories', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(newStory)
			});
			if (res.ok) {
				loadStories(user.id);
				document.getElementById('story-form').reset();
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
			} else {
				const data = await res.json();
				alert(data.error || 'Failed to save story');
			}
		}

		function renderStories(stories) {
			const storiesGrid = document.getElementById('stories-grid');
			const emptyState = document.getElementById('empty-state');
			const storiesCount = document.getElementById('stories-count');
			storiesCount.textContent = stories.length;
			if (stories.length === 0) {
				emptyState.classList.remove('hidden');
				storiesGrid.classList.add('hidden');
				return;
			}
			emptyState.classList.add('hidden');
			storiesGrid.classList.remove('hidden');
			storiesGrid.innerHTML = stories.map(story => `
		<div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm hover:shadow-md transition-shadow story-card" data-story-id="${story.id}">
			<div class="flex justify-between items-start mb-3">
				<div>
					<h3 class="font-semibold text-gray-900 text-lg line-clamp-2">
						${story.title}
					</h3>
					${story.author ? `<p class="text-xs text-gray-600">by ${story.author}</p>` : ''}
				</div>
				${story.chapter ? (
					story.url
						? `<a href="${story.url}" target="_blank" class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-semibold hover:underline focus:outline-none" title="Go to story">Chapter ${story.chapter}</a>`
						: `<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-semibold">Chapter ${story.chapter}</span>`
				) : ''}
			</div>
			${story.description ? `
				<p class="text-gray-900 text-sm mb-3 line-clamp-3">
					${story.description}
				</p>
			` : ''}
			${story.url ? `<a href="${story.url}" target="_blank" class="text-blue-600 text-xs underline break-all">Read Original</a><br/>` : ''}
			${story.tags ? `<p class="text-xs text-gray-500 mt-1">Tags: ${story.tags}</p>` : ''}
			<p class="text-xs text-gray-600 mt-3">
				Saved on ${new Date(story.created_at).toLocaleDateString()}
			</p>
			<button class="remove-story-btn mt-3 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-xs" data-story-id="${story.id}">Remove</button>
		</div>
	`).join('');
			const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);

			// Attach remove handlers
			document.querySelectorAll('.remove-story-btn').forEach(btn => {
				btn.addEventListener('click', function () {
					const storyId = this.getAttribute('data-story-id');
					handleRemoveStory(storyId);
				});
			});
		}

		async function handleRemoveStory(storyId) {
			if (!confirm('Are you sure you want to remove this story?')) return;
			const user = JSON.parse(localStorage.getItem('storySaverUser') || 'null');
			if (!user) {
				alert('Please sign in to remove stories.');
				return;
			}
			const res = await fetch(`/api/stories/${encodeURIComponent(storyId)}`, {
				method: 'DELETE'
			});
			if (res.ok) {
				loadStories(user.id);
			} else {
				let errorMsg = 'Failed to remove story';
				const contentType = res.headers.get('content-type');
				if (contentType && contentType.includes('application/json')) {
					const data = await res.json();
					errorMsg = data.error || errorMsg;
				} else {
					const text = await res.text();
					errorMsg = text || errorMsg;
				}
				alert(errorMsg);
			}
		}

		function handleLogout() {
			localStorage.removeItem('storySaverUser');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('auth-form').reset();
			document.getElementById('welcome-user').textContent = 'Welcome, Guest';
			document.getElementById('logout-btn').classList.add('hidden');
			document.getElementById('signin-btn').classList.remove('hidden');
			renderStories([]);
		}
	</script>
</body>
</html>
