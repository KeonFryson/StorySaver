<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>StorySaver</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			darkMode: 'class'
		}
	</script>
	<style>
		.line-clamp-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.line-clamp-3 {
			display: -webkit-box;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		#add-story-modal-backdrop {
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.3);
			z-index: 40;
			display: none;
		}

		#add-story-modal {
			z-index: 50;
		}
	</style>
</head>
<body class="min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-white transition-colors duration-300" id="body-root">
	<div id="app">
		<!-- Auth Page (hidden by default) -->
		<div id="auth-page" class="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-800 dark:text-white flex items-center justify-center p-4 hidden">
			<div class="w-full max-w-md bg-white dark:bg-gray-900 rounded-lg shadow-lg p-6 border border-gray-200 dark:border-gray-600">
				<div class="text-center mb-6">
					<h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2">StorySaver</h1>
					<p class="text-gray-600 dark:text-gray-300">Archive your favorite stories like AO3</p>
				</div>
				<form id="auth-form" class="space-y-4">
					<div>
						<label for="email" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
							Email
						</label>
						<input id="email"
							   type="email"
							   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
							   placeholder="your@email.com"
							   required />
					</div>
					<div>
						<label for="password" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
							Password
						</label>
						<input id="password"
							   type="password"
							   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
							   placeholder="••••••••"
							   required />
					</div>
					<button type="submit"
							class="w-full bg-blue-600 dark:bg-blue-700 text-white py-2 px-4 rounded-md hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors font-medium">
						Sign In
					</button>
				</form>
				<div class="mt-4 text-center">
					<button type="button"
							id="toggle-signup"
							class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm">
						Need an account? Sign up
					</button>
				</div>
				<div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
					<h3 class="font-semibold text-gray-900 dark:text-white mb-2">Why StorySaver?</h3>
					<ul class="text-sm text-gray-600 dark:text-gray-300 space-y-1">
						<li>• Save stories from AO3, SpaceBattles, and more</li>
						<li>• Organize with tags and categories</li>
						<li>• Access your library anywhere</li>
						<li>• Never lose your favorite reads</li>
					</ul>
				</div>
			</div>
		</div>

		<!-- Dashboard Page (visible by default) -->
		<div id="dashboard-page" class="min-h-screen bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white transition-colors duration-300">
			<!-- Header -->
			<header class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-600 shadow-sm transition-colors duration-300">
				<div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
					<div>
						<h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">StorySaver</h1>
						<p class="text-sm text-gray-600 dark:text-gray-300">Your personal story archive</p>
					</div>
					<div class="flex items-center gap-4">
						<span class="text-gray-900 dark:text-white" id="welcome-user">Welcome, Guest</span>
						<button id="darkmode-btn"
								class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-3 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm"
								title="Toggle dark mode">
							Dark Mode
						</button>
						<button id="signin-btn"
								class="bg-blue-600 dark:bg-blue-700 text-white px-4 py-2 rounded-md hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors text-sm">
							Sign In
						</button>
						<button id="logout-btn"
								class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm hidden">
							Logout
						</button>
					</div>
				</div>
			</header>
			<div class="max-w-6xl mx-auto px-4 py-8 relative">
				<!-- Floating + Button -->
				<button id="show-add-story-btn"
						class="fixed bottom-8 right-8 bg-blue-600 dark:bg-blue-700 text-white rounded-full w-16 h-16 flex items-center justify-center text-4xl shadow-lg hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors z-50"
						title="Add New Story"
						style="box-shadow: 0 4px 24px rgba(0,0,0,0.15);">
					+
				</button>

				<!-- Add Story Modal (hidden by default) -->
				<div id="add-story-modal-backdrop"></div>
				<div id="add-story-modal" class="fixed inset-0 flex items-center justify-center hidden">
					<div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-600 p-6 shadow-lg w-full max-w-lg relative add-story-box">
						<button id="close-add-story-btn" class="absolute top-3 right-3 text-gray-400 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white text-2xl font-bold" title="Close">&times;</button>
						<h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Add New Story</h2>
						<form id="story-form" class="space-y-4">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Title *
									</label>
									<input id="story-title"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="Story title"
										   required />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Author
									</label>
									<input id="story-author"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="Author name" />
								</div>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Author URL
									</label>
									<input id="story-author-url"
										   type="url"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="https://authorwebsite.com" />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Chapter
									</label>
									<input id="story-chapter"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="e.g. 1, 2, Prologue, etc." />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Max Chapter
									</label>
									<input id="story-max-chapter"
										   type="text"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="e.g. 10, 25, Epilogue, etc." />
								</div>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										URL
									</label>
									<input id="story-url"
										   type="url"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="https://archiveofourown.org/works/..." />
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
										Chapter URL
									</label>
									<input id="story-chapter-url"
										   type="url"
										   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										   placeholder="https://chapterlink.com" />
								</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
									Content or Summary
								</label>
								<textarea id="story-content"
										  rows="3"
										  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
										  placeholder="Paste content or write a summary..."></textarea>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
									Tags (comma-separated)
								</label>
								<input id="story-tags"
									   type="text"
									   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
									   placeholder="fanfiction, sci-fi, romance" />
							</div>
							<button type="submit"
									class="bg-blue-600 dark:bg-blue-700 text-white px-6 py-2 rounded-md hover:bg-blue-700 dark:hover:bg-blue-800 transition-colors font-medium">
								Save Story
							</button>
						</form>
					</div>
				</div>
				<!-- Add this above the stories grid inside the dashboard-page -->
				<div class="mb-6">
					<button id="toggle-filter-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-3 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">
						Filter Stories
					</button>
					<div id="stories-filter-panel" class="mt-2 p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg hidden">
						<label class="block mb-2 font-medium text-gray-900 dark:text-white">Sort By:</label>
						<select id="stories-sort-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white">
							<option value="lastAddedDesc">Last Added (Newest First)</option>
							<option value="lastAddedAsc">Last Added (Oldest First)</option>
							<option value="titleAZ">Title (A-Z)</option>
							<option value="titleZA">Title (Z-A)</option>
						</select>
					</div>
				</div>
				<div class="mb-4 flex items-center gap-2">
					<input type="text"
						   id="story-search-input"
						   class="w-full md:w-1/2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
						   placeholder="Search stories by title..."
						   autocomplete="off" />
				</div>
				<!-- Reload All Stories Button -->
				<div class="mb-4 flex items-center gap-2">
					<button id="reload-all-stories-btn"
							class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md flex items-center gap-2"
							title="Reload all stories">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 20 20" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582M19 11a7.002 7.002 0 01-13.197 4.25M5 19v-5h-.582M1 9a7.002 7.002 0 0113.197-4.25" />
						</svg>
						Reload All
					</button>
				</div>
				<!-- Stories Grid -->
				<div>
					<h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">Your Saved Stories (<span id="stories-count">0</span>)</h2>
					<div id="empty-state" class="text-center py-12 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
						<p class="text-gray-600 dark:text-gray-300">No stories saved yet. Add your first story above!</p>
					</div>
					<div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
						<!-- Stories will be dynamically added here -->
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		function setDarkMode(enabled) {
			const html = document.documentElement;
			if (enabled) {
				html.classList.add('dark');
			} else {
				html.classList.remove('dark');
			}
			localStorage.setItem('storySaverDarkMode', enabled ? '1' : '0');
		}

		let editingStoryId = null;
		let currentSearchTerm = "";

		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('welcome-user').textContent = 'Welcome, Guest';
			document.getElementById('logout-btn').classList.add('hidden');
			document.getElementById('signin-btn').classList.remove('hidden');

			document.getElementById('signin-btn').addEventListener('click', function () {
				document.getElementById('dashboard-page').classList.add('hidden');
				document.getElementById('auth-page').classList.remove('hidden');
				const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
				setDarkMode(darkMode);
			});

			const darkBtn = document.getElementById('darkmode-btn');
			let darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);
			darkBtn.textContent = darkMode ? 'Light Mode' : 'Dark Mode';
			darkBtn.addEventListener('click', function () {
				darkMode = !darkMode;
				setDarkMode(darkMode);
				darkBtn.textContent = darkMode ? 'Light Mode' : 'Dark Mode';
			});

			document.getElementById('auth-form').addEventListener('submit', handleAuth);
			document.getElementById('toggle-signup').addEventListener('click', toggleSignUp);
			document.getElementById('story-form').addEventListener('submit', handleSaveStory);
			document.getElementById('logout-btn').addEventListener('click', handleLogout);

			// Modal logic
			document.getElementById('add-story-modal').classList.add('hidden');
			document.getElementById('add-story-modal-backdrop').style.display = 'none';
			document.getElementById('show-add-story-btn').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.remove('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'block';
			});
			document.getElementById('close-add-story-btn').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
			});
			document.getElementById('add-story-modal-backdrop').addEventListener('click', function () {
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
			});

			const savedUser = localStorage.getItem('storySaverUser');
			if (savedUser) {
				const user = JSON.parse(savedUser);
				showDashboard(user.email);
				loadStories(user.id);
			} else {
				renderStories([]);
			}
		});

		// Helper to filter and sort stories
		function filterAndRenderStories() {
			let filtered = currentStories;
			if (currentSearchTerm) {
				filtered = filtered.filter(story =>
					(story.title || "").toLowerCase().includes(currentSearchTerm)
				);
			}
			const sorted = sortStories(filtered, currentSortMode);
			renderStories(sorted);
		}

		document.getElementById('story-search-input').addEventListener('input', function (e) {
			currentSearchTerm = e.target.value.trim().toLowerCase();
			filterAndRenderStories();
		});

		document.getElementById('stories-sort-select').addEventListener('change', function (e) {
			currentSortMode = e.target.value;
			filterAndRenderStories();
		});

		document.getElementById('toggle-filter-btn').addEventListener('click', function () {
			const panel = document.getElementById('stories-filter-panel');
			panel.classList.toggle('hidden');
		});

		let currentStories = [];
		let currentSortMode = 'lastAddedDesc';

		function sortStories(stories, mode) {
			switch (mode) {
				case 'lastAddedDesc':
					return [...stories].sort((a, b) => new Date(b.dateSaved || b.created_at) - new Date(a.dateSaved || a.created_at));
				case 'lastAddedAsc':
					return [...stories].sort((a, b) => new Date(a.dateSaved || a.created_at) - new Date(b.dateSaved || b.created_at));
				case 'titleAZ':
					return [...stories].sort((a, b) => (a.title || '').localeCompare(b.title || ''));
				case 'titleZA':
					return [...stories].sort((a, b) => (b.title || '').localeCompare(a.title || ''));
				default:
					return stories;
			}
		}

		document.getElementById('stories-sort-select').addEventListener('change', function (e) {
			currentSortMode = e.target.value;
			renderStories(sortStories(currentStories, currentSortMode));
		});

		async function handleAuth(e) {
			e.preventDefault();
			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;
			const isSignUp = document.getElementById('toggle-signup').textContent.trim() === 'Already have an account? Sign in';

			if (isSignUp) {
				const res = await fetch('/api/users', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, username: email, password })
				});
				const data = await res.json();
				if (res.ok) {
					alert('Account created successfully!');
					toggleSignUp();
				} else {
					alert(data.error || 'Sign up failed');
				}
			} else {
				const res = await fetch('/api/auth', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, password })
				});
				const data = await res.json();
				if (res.ok && data.user) {
					localStorage.setItem('storySaverUser', JSON.stringify(data.user));
					showDashboard(data.user.email);
					loadStories(data.user.id);
				} else {
					alert(data.error || 'Invalid credentials!');
				}
			}
		}

		function toggleSignUp() {
			const button = document.getElementById('toggle-signup');
			const submitBtn = document.getElementById('auth-form').querySelector('button[type="submit"]');
			if (button.textContent.trim() === 'Need an account? Sign up') {
				button.textContent = 'Already have an account? Sign in';
				submitBtn.textContent = 'Create Account';
			} else {
				button.textContent = 'Need an account? Sign up';
				submitBtn.textContent = 'Sign In';
			}
		}

		function showDashboard(userEmail) {
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('welcome-user').textContent = 'Welcome, ' + userEmail;
			document.getElementById('logout-btn').classList.remove('hidden');
			document.getElementById('signin-btn').classList.add('hidden');
			const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);
		}

		async function loadStories(userId) {
			if (!userId) {
				currentStories = [];
				filterAndRenderStories();
				return;
			}
			const res = await fetch(`/api/stories?user_id=${encodeURIComponent(userId)}`);
			currentStories = res.ok ? await res.json() : [];
			console.log(currentStories);
			filterAndRenderStories();
		}

		async function handleSaveStory(e) {
			e.preventDefault();
			const user = JSON.parse(localStorage.getItem('storySaverUser') || 'null');
			if (!user) {
				alert('Please sign in to save stories.');
				return;
			}
			const newStory = {
				user_id: user.id,
				title: document.getElementById('story-title').value,
				description: document.getElementById('story-content').value,
				chapter: document.getElementById('story-chapter').value,
				maxChapter: document.getElementById('story-max-chapter').value,
				author: document.getElementById('story-author').value,
				authorurl: document.getElementById('story-author-url').value,
				url: document.getElementById('story-url').value,
				chapterurl: document.getElementById('story-chapter-url').value,
				tags: document.getElementById('story-tags').value,
				dateSaved: new Date().toISOString()
			};
			let res;
			if (editingStoryId) {
				res = await fetch(`/api/stories/${encodeURIComponent(editingStoryId)}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(newStory)
				});
			} else {
				res = await fetch('/api/stories', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(newStory)
				});
			}
			if (res.ok) {
				loadStories(user.id);
				document.getElementById('story-form').reset();
				document.getElementById('add-story-modal').classList.add('hidden');
				document.getElementById('add-story-modal-backdrop').style.display = 'none';
				editingStoryId = null;
				document.querySelector('#story-form button[type="submit"]').textContent = 'Save Story';
			} else {
				const data = await res.json();
				alert(data.error || 'Failed to save story');
			}
		}

		function renderStories(stories) {
			const storiesGrid = document.getElementById('stories-grid');
			const emptyState = document.getElementById('empty-state');
			const storiesCount = document.getElementById('stories-count');
			storiesCount.textContent = stories.length;
			if (stories.length === 0) {
				emptyState.classList.remove('hidden');
				storiesGrid.classList.add('hidden');
				return;
			}
			emptyState.classList.add('hidden');
			storiesGrid.classList.remove('hidden');
			storiesGrid.innerHTML = stories.map(story => {
				return `
<div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-600 p-4 shadow-sm hover:shadow-lg hover:scale-[1.02] transition-shadow transition-transform duration-200 story-card relative" data-story-id="${story.id}">
		<!-- 3-dot menu -->
		<div class="relative flex justify-end">
			<button class="story-menu-btn absolute top-2 right-2 text-gray-400 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white text-2xl font-bold" title="Menu">&#8942;</button>
			<div class="story-menu-dropdown hidden absolute top-8 right-2 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded shadow-lg z-10 min-w-[120px]">
				<button class="edit-story-btn block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700" data-story-id="${story.id}">Edit</button>
				<button class="remove-story-btn block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900" data-story-id="${story.id}">Remove</button>
			</div>
		</div>
		<h3 class="font-semibold text-gray-900 dark:text-white text-lg line-clamp-2 mb-2">
			${story.title}
		</h3>
		<div class="flex flex-wrap gap-2 mb-3">
			<span class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white text-xs px-2 py-1 rounded">Author: ${story.author || 'Unknown'}</span>
			<span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-xs px-2 py-1 rounded">
				Chapter: ${story.currentThreadmarkNumber && story.maxChapter
						? `${parseInt(story.currentThreadmarkNumber, 10)} / ${parseInt(story.maxChapter, 10)}`
						: (story.chapter || 'N/A')
					}
			</span>
			${story.authorurl ? `<a href="${story.authorurl}" target="_blank" class="inline-block bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-xs px-2 py-1 rounded">Author Profile</a>` : ''}
			${story.chapterurl ? `<a href="${story.chapterurl}" target="_blank" class="inline-block bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-xs px-2 py-1 rounded">Current Chapter Link</a>` : ''}
		</div>
		${story.description ? `
			<p class="text-gray-900 dark:text-white text-sm mb-3 line-clamp-3">
				${story.description}
			</p>
		` : ''}
		${story.tags ? `<p class="text-xs text-gray-500 dark:text-gray-300 mt-1">Tags: ${story.tags}</p>` : ''}
		<p class="text-xs text-gray-600 dark:text-gray-300 mt-3">
			Saved on ${story.dateSaved ? new Date(story.dateSaved).toLocaleString() : (story.created_at ? new Date(story.created_at).toLocaleString() : '')}
		</p>
		${story.created_at ? `<p class="text-xs text-gray-400 dark:text-gray-500">Created: ${new Date(story.created_at).toLocaleString()}</p>` : ''}
</div>
`;
			}).join('');
			const darkMode = localStorage.getItem('storySaverDarkMode') === '1';
			setDarkMode(darkMode);

			// Menu logic
			document.querySelectorAll('.story-menu-btn').forEach(btn => {
				btn.addEventListener('click', function (e) {
					e.stopPropagation();
					const card = btn.closest('.story-card');
					const dropdown = card.querySelector('.story-menu-dropdown');
					document.querySelectorAll('.story-menu-dropdown').forEach(d => {
						if (d !== dropdown) d.classList.add('hidden');
					});
					dropdown.classList.toggle('hidden');
				});
			});
			document.addEventListener('click', function () {
				document.querySelectorAll('.story-menu-dropdown').forEach(d => d.classList.add('hidden'));
			});
			document.querySelectorAll('.edit-story-btn').forEach(btn => {
				btn.addEventListener('click', function (e) {
					e.stopPropagation();
					const storyId = this.getAttribute('data-story-id');
					const story = stories.find(s => s.id == storyId);
					if (story) openEditModal(story);
					this.closest('.story-menu-dropdown').classList.add('hidden');
				});
			});
			document.querySelectorAll('.remove-story-btn').forEach(btn => {
				btn.addEventListener('click', function (e) {
					e.stopPropagation();
					const storyId = this.getAttribute('data-story-id');
					handleRemoveStory(storyId);
					this.closest('.story-menu-dropdown').classList.add('hidden');
				});
			});

			document.querySelectorAll('.story-card').forEach(card => {
				const storyId = card.getAttribute('data-story-id');
				const story = stories.find(s => s.id == storyId);
				if (story && story.url) {
					card.style.cursor = 'pointer';
					card.addEventListener('click', function (e) {
						if (
							e.target.classList.contains('edit-story-btn') ||
							e.target.classList.contains('remove-story-btn') ||
							e.target.classList.contains('story-menu-btn') ||
							e.target.classList.contains('story-menu-dropdown')
						) return;
						window.open(story.url, '_blank');
					});
				}
			});
		}

		document.getElementById('reload-all-stories-btn').addEventListener('click', async function () {
			const btn = this;
			btn.disabled = true;
			const originalHtml = btn.innerHTML;
			btn.innerHTML = '<span class="animate-spin">⟳</span> Reloading...';

			// Get all current stories
			const stories = currentStories;
			if (!stories || stories.length === 0) {
				alert('No stories to reload.');
				btn.disabled = false;
				btn.innerHTML = originalHtml;
				return;
			}

			let errors = [];
			for (const story of stories) {
				try {
					const res = await fetch(`/api/stories/${story.id}/update-chapters`, { method: 'POST' });
					if (!res.ok) {
						const data = await res.json();
						errors.push(`${story.title}: ${data.error || 'Failed'}`);
					}
				} catch (err) {
					errors.push(`${story.title}: ${err.message}`);
				}
			}

			const user = JSON.parse(localStorage.getItem('storySaverUser') || 'null');
			if (user) await loadStories(user.id);

			btn.disabled = false;
			btn.innerHTML = originalHtml;

			if (errors.length > 0) {
				alert('Some stories failed to reload:\n' + errors.join('\n'));
			} else {
				alert('All stories reloaded!');
			}
		});
		function openEditModal(story) {
			editingStoryId = story.id;
			document.getElementById('add-story-modal').classList.remove('hidden');
			document.getElementById('add-story-modal-backdrop').style.display = 'block';
			document.getElementById('story-title').value = story.title || '';
			document.getElementById('story-author').value = story.author || '';
			document.getElementById('story-author-url').value = story.authorurl || '';
			document.getElementById('story-chapter').value = story.chapter || '';
			document.getElementById('story-max-chapter').value = story.maxChapter || '';
			document.getElementById('story-chapter-url').value = story.chapterurl || '';
			document.getElementById('story-url').value = story.url || '';
			document.getElementById('story-content').value = story.description || '';
			document.getElementById('story-tags').value = story.tags || '';
			document.querySelector('#story-form button[type="submit"]').textContent = 'Update Story';
		}
		document.getElementById('close-add-story-btn').addEventListener('click', function () {
			editingStoryId = null;
			document.getElementById('story-form').reset();
			document.querySelector('#story-form button[type="submit"]').textContent = 'Save Story';
		});
		document.getElementById('add-story-modal-backdrop').addEventListener('click', function () {
			editingStoryId = null;
			document.getElementById('story-form').reset();
			document.querySelector('#story-form button[type="submit"]').textContent = 'Save Story';
		});

		async function handleRemoveStory(storyId) {
			if (!confirm('Are you sure you want to remove this story?')) return;
			const user = JSON.parse(localStorage.getItem('storySaverUser') || 'null');
			if (!user) {
				alert('Please sign in to remove stories.');
				return;
			}
			const res = await fetch(`/api/stories/${encodeURIComponent(storyId)}`, {
				method: 'DELETE'
			});
			if (res.ok) {
				loadStories(user.id);
			} else {
				let errorMsg = 'Failed to remove story';
				const contentType = res.headers.get('content-type');
				if (contentType && contentType.includes('application/json')) {
					const data = await res.json();
					errorMsg = data.error || errorMsg;
				} else {
					const text = await res.text();
					errorMsg = text || errorMsg;
				}
				alert(errorMsg);
			}
		}

		function handleLogout() {
			localStorage.removeItem('storySaverUser');
			document.getElementById('dashboard-page').classList.remove('hidden');
			document.getElementById('auth-page').classList.add('hidden');
			document.getElementById('auth-form').reset();
			document.getElementById('welcome-user').textContent = 'Welcome, Guest';
			document.getElementById('logout-btn').classList.add('hidden');
			document.getElementById('signin-btn').classList.remove('hidden');
			renderStories([]);
		}
	</script>
</body>
</html>
